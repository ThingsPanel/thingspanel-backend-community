# 消息推送（手机端） — 现状逆向分析（简洁）

参考项目目录结构：`internal/api` / `internal/service` / `internal/dal` / `internal/model`。

- 数据表（已存在）
  - `message_push_config`：推送服务配置（url、类型）。见 `sql/6.sql`。
  - `message_push_manage`：用户推送ID 列表与状态（push_id、last_push_time、err_count、inactive_time）。
  - `message_push_log`：推送发送日志（content、status、err_message）。
  - `message_push_rule_log`：失效规则记录（记录何时/为何失效）。

- 关键后端代码位置（快速导读）
  - 路由与 API：`router/apps/message_push.go`（初始化接口）

```11:21:router/apps/message_push.go
func (*MessagePush) Init(Router *gin.RouterGroup) {
	url := Router.Group("message_push")
	{
		// 增
		url.POST("", api.Controllers.MessagePushApi.CreateMessagePush)
		//注销
		url.POST("/logout", api.Controllers.MessagePushApi.MessagePushMangeLogout)
		//获取配置
		url.GET("/config", api.Controllers.MessagePushApi.GetMessagePushConfig)
		//设置配置
		url.POST("/config", api.Controllers.MessagePushApi.SetMessagePushConfig)
	}
}
```

  - API 层：`internal/api/message_push.go` — 简单的请求校验后调用 `service.GroupApp.MessagePush`。
  - 业务逻辑：`internal/service/message_push.go` — 当前已实现：
    - 设备/用户绑定登记：`CreateMessagePush`、`MessagePushMangeLogout`（管理 `message_push_manage`）。
    - 推送配置读写：`GetMessagePushConfig` / `SetMessagePushConfig`（操作 `message_push_config`）。
    - 发送请求到第三方推送服务：`MessagePushSend`（基于 `message_push_config.url` 发 HTTP POST）。
    - 告警触发推送入口：`AlarmMessagePushSend`（遍历租户下的 push id 并调用发送+记录）。
    - 发送结果落库与统计：`MessagePushSendAndLog`（写 `message_push_log`，更新 manage 的 `last_push_time/err_count`）。

```21:36:internal/service/message_push.go
func (receiver *MessagePush) CreateMessagePush(req *model.CreateMessagePushReq, userId string) error {
	exists, err := dal.GetMessagePushMangeExists(userId, req.PushId)
	if err != nil {
		return err
	}
	if exists {
		return dal.ActiveMessagePushMange(userId, req.PushId, req.DeviceType)
	}
	return dal.CreateMessagePushMange(&model.MessagePushManage{
		ID:         uuid.New(),
		UserID:     userId,
		PushID:     req.PushId,
		DeviceType: req.DeviceType,
		Status:     1,
		CreateTime: time.Now(),
	})
}
```

  - 持久层：`internal/dal/message_push.go` — CRUD 与查询封装（示例：获取/设置配置、写日志、获取用户 push id）。

```51:54:internal/dal/message_push.go
func GetMessagePushConfig() (*model.MessagePushConfigRes, error) {
	var result model.MessagePushConfigRes
	return &result, query.MessagePushConfig.Where(query.MessagePushConfig.ConfigType.Eq(1)).Scan(&result)
}
```

- 定时任务
  - `initialize/croninit/cron.go` 已注册每天定时调用 `service.GroupApp.MessagePush.MessagePushMangeClear()`，用于清理不活跃/异常的 push 管理记录。

- 当前实现覆盖（已完成）
  - 用户端注册/注销 push id（`message_push_manage` 的增/更新）。
  - 推送配置的 CRUD（`message_push_config`）。
  - 以告警为入口的推送触发与 HTTP 转发实现（并记录 `message_push_log`，更新 `last_push_time/err_count`）。
  - 定期清理不活跃数据（cron）。

- 缺口 / 建议的后续开发（供你继续）
  1. 前端/移动端接入规范：补充客户端注册/注销流程与推送 ID 格式校验（文档/示例）。
  2. 可视化管理界面（或 API）：
     - 查询 `message_push_manage`（按租户/用户）和 `message_push_log`（按时间/状态）；
     - 在管理界面添加“重试失败推送/导出日志”功能。
  3. 配置回退与失败重试：当前发送仅记录结果，建议加入异步重试队列（Rabbit/Redis）或按次级策略重试。
  4. 监控告警：增加推送失败率与平均延迟 Prometheus 指标（`message_push_log` 汇总）。
  5. 测试与模拟：提供本地模拟推送端点与 E2E 测试用例（确保 `MessagePushSend` 在不同返回结构下均可处理）。

如需，我可以：
 - 把上面每项缺口拆成具体实现 TODO 并开始实现其中一项（例如：增加日志查询 API / 前端示例），或
 - 直接生成一个“前端注册示例（JS）”与“调用告警触发推送的后端单元测试”样例。



 
