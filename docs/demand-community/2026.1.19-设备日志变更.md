# 2026.1.19 - 增加设备调试日志功能（通用交互日志规范，简版方案）

## 1. 目标

通过“日志”的方式清晰定位 **设备与平台的交互问题**（接入、上下行消息、协议映射等）。

本方案强调 **日志结构协议无关**：同一套 JSON 结构可用于 MQTT / Modbus / TCP 等协议服务；协议私有信息统一放到 `meta` 字段中。

> 现阶段：由 MQTT Broker（thingspanel-gmqtt 插件）采集并写入 Redis  
> 后续：其它协议服务按同一规范写入即可

## 2. 记录范围（只做这些）

仅在设备开启“调试模式”期间记录 **与设备交互相关** 的日志：

1) **鉴权/连接类**（例如 MQTT 的 `auth`）
- 成功/失败、失败原因（不记录明文密码）

2) **订阅/绑定类**（例如 MQTT 的 `subscribe`）
- 订阅主题、允许/拒绝、拒绝原因（白名单拒绝/自定义映射放行等）

3) **上行消息**（设备 → 平台，`direction=up`）
- 设备上行的主题/地址/寄存器等协议私有信息放在 `meta`
- 若命中“上行自定义映射”，记录映射后的目标（放 `meta.target_*`）

4) **下行消息**（平台 → 设备，`direction=down`）
- 平台下发后若触发“额外转发/自定义映射”，记录转发结果与目标（放 `meta.*`）

不记录：与设备交互无关的日志（DB/Redis 连接、缓存命中、系统初始化等）。

## 3. 存储方案（Redis，短期）

调试日志按设备写入 Redis，短期保存即可。

### 3.1 Key 约定

- 调试开关：`tp:devdebug:cfg:{device_id}`
- 调试日志：`tp:devdebug:logs:{device_id}`

### 3.2 调试开关（cfg）

JSON 示例：

```json
{
  "enabled": true,
  "expire_at": 1760000000,
  "max_items": 1000,
  "payload_max_bytes": 4096
}
```

说明：
- 超过 `expire_at` 视为关闭
- `payload_max_bytes` 用于截断 payload，避免大报文撑爆 Redis 与页面渲染  
  - 可配置为 `0`：不记录 payload，只记录元信息

### 3.3 调试日志（logs）

Redis List：
- 写入：`LPUSH tp:devdebug:logs:{device_id} <json>`
- 限长：`LTRIM ... 0 (max_items-1)`
- 过期：`EXPIRE ... ttlSeconds`（建议 `duration + 10 分钟`）

#### 3.3.1 通用日志结构（协议无关）

单条日志 JSON：

```json
{
  "ts": "2026-01-16T14:23:01.123+08:00",
  "device_id": "xxx",
  "protocol": "mqtt",
  "direction": "up",
  "action": "publish",
  "outcome": "ok",
  "error": "",
  "payload": "{\"temp\":25}",
  "meta": {
    "topic": "devices/telemetry",
    "client_id": "device001",
    "qos": 1,
    "mapped": true,
    "target_topic": "devices/telemetry"
  }
}
```

字段说明（尽量少、尽量通用）：
- `ts`：时间（RFC3339/RFC3339Nano）
- `device_id`：设备 ID（必须）
- `protocol`：协议类型（可选但推荐：`mqtt`/`modbus`/`tcp`/…）
- `direction`：方向  
  - `up`：设备发来的（设备 → 平台）  
  - `down`：平台发给设备的（平台 → 设备）  
  - `na`：无方向/连接类事件（例如 connect/auth）
- `action`：动作/事件名称（字符串，协议可自定义；建议使用简短动词）
  - MQTT 示例：`auth`/`subscribe`/`publish`/`forward`
  - Modbus 示例：`read`/`write`
  - TCP 示例：`connect`/`disconnect`/`heartbeat`/`packet`
- `outcome`：处理结果（可选）  
  - `ok`：成功  
  - `deny`：拒绝/不允许（例如权限/白名单）  
  - `error`：发生错误（`error` 字段给原因）  
  - `drop`：被丢弃（例如已转发/已重写，主动不再继续原流程）
- `error`：错误原因（可选；不包含敏感信息）
- `payload`：载荷（可选，按 `payload_max_bytes` 截断；可为空）
- `meta`：协议私有信息（可选对象）  
  - MQTT：`topic`/`client_id`/`qos`/映射前后 topic 等  
  - Modbus：`unit_id`/`function_code`/`address`/`quantity` 等  
  - TCP：`remote_addr`/`local_addr`/`frame_len` 等

敏感信息：
- 不记录密码/密钥等敏感字段；如必须定位问题，建议在 `meta` 内做脱敏后再写入。

## 4. 采集点（基于现有 Hook）

采集入口（MQTT）在 `plugin/thingspanel/hooks.go`：
- `OnBasicAuthWrapper`：鉴权（`action=auth`）
- `OnSubscribeWrapper`：订阅（`action=subscribe`）
- `OnMsgArrivedWrapper`：
  - 上行：发布（`action=publish` + `direction=up`）
  - 下行：额外转发（`action=forward` + `direction=down`）

写入前统一判断该 `device_id` 是否处于调试开启状态（读取 `tp:devdebug:cfg:{device_id}`）。

## 5. 对外接口（由 IoT 平台提供）

本插件不实现对外 REST 接口；建议由 IoT 平台（ThingsPanel 后端）提供 3 个接口读写 Redis：

1) 开启/关闭调试
- `POST /api/v1/device/{device_id}/debug`（参数：`duration` 或 `expire_at`）

2) 查询日志
- `GET /api/v1/device/{device_id}/debug/logs?offset=0&limit=100`

3) 查询调试状态
- `GET /api/v1/device/{device_id}/debug/status`

## 6. 默认参数建议

- 默认开启时长：30 分钟（到期自动关闭）
- `max_items`：1000
- `payload_max_bytes`：4096（可配置为 0：不记录 payload）
- Redis TTL：`duration + 10 分钟`
