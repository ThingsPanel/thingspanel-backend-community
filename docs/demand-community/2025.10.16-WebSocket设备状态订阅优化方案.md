# WebSocket è®¾å¤‡çŠ¶æ€è®¢é˜…ä¼˜åŒ–æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025å¹´10æœˆ16æ—¥  
**æ¥å£**: `/api/v1/device/online/status/ws`  
**ç›®æ ‡**: è§£å†³ WebSocket ç›´æ¥è®¢é˜… MQTT å¯¼è‡´çš„æ¶æ„é—®é¢˜

---

## ğŸ“Š ç°çŠ¶é—®é¢˜

### å½“å‰æ¶æ„

```
WebSocket è¯·æ±‚
    â†“
API Handler
    â†“
åˆ›å»ºç‹¬ç«‹ MQTT å®¢æˆ·ç«¯ â† é—®é¢˜æ‰€åœ¨
    â†“
ç›´æ¥è®¢é˜… devices/status/{id}
```

### å­˜åœ¨çš„é—®é¢˜

1. **ç»•è¿‡ Flow å±‚**
   - æ— æ³•åº”ç”¨ä¸‰ç§æ¨¡å¼é€»è¾‘ï¼ˆå¿ƒè·³/è¶…æ—¶/æ¶ˆæ¯æ¨¡å¼ï¼‰
   - æ•°æ®ä¸èµ° StatusFlow ç»Ÿä¸€å¤„ç†
   - ä¸å…¶ä»–æ•°æ®æºï¼ˆKafkaï¼‰å¤„ç†é€»è¾‘ä¸ä¸€è‡´

2. **èµ„æºæµªè´¹**
   - æ¯ä¸ª WebSocket åˆ›å»ºä¸€ä¸ª MQTT å®¢æˆ·ç«¯
   - è™½ç„¶å®é™…è¿æ¥æ•°ä¸å¤šï¼Œä½†æ¶æ„ä¸åˆç†

3. **æ•°æ®æºè€¦åˆ**
   - ç°åœ¨æ•°æ®å¯èƒ½æ¥è‡ª Kafka æˆ– MQTT
   - ä¸èƒ½ä¾èµ–ä¸Šæ¸¸ MQTT è®¢é˜…

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**é€šè¿‡ Redis Pub/Sub è§£è€¦**ï¼š
- æ‰€æœ‰çŠ¶æ€æ•°æ®ç»Ÿä¸€ä» Flow å±‚å‡ºæ¥
- StatusFlow å‘å¸ƒåˆ° Redis
- WebSocket è®¢é˜… Redisï¼ˆè€Œé MQTTï¼‰
- æ”¯æŒé›†ç¾¤éƒ¨ç½²

---

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### æ•°æ®æµå‘

```
Kafka/MQTT â†’ MQTTAdapter â†’ Bus â†’ StatusFlow
                                      â†“
                          1. æ›´æ–°æ•°æ®åº“
                          2. SSE é€šçŸ¥
                          3. è§¦å‘è‡ªåŠ¨åŒ–
                          4. ğŸ†• å‘å¸ƒåˆ° Redis
                                      â†“
                          Redis PUBLISH device:{id}:status
                                      â†“
                          å„å®ä¾‹çš„ WebSocket Handler
                                      â†“
                          æ¨é€ç»™å‰ç«¯
```

### å…³é”®è®¾è®¡ç‚¹

#### 1. é¢‘é“è®¾è®¡

**é‡‡ç”¨å¤šé¢‘é“æ–¹æ¡ˆ**ï¼ˆæ¯è®¾å¤‡ä¸€ä¸ªé¢‘é“ï¼‰

- **é¢‘é“å‘½å**: `device:{device_id}:status`
- **åŸå› **: 
  - æ¯ä¸ª WS åªå…³å¿ƒ 1 ä¸ªè®¾å¤‡
  - ç²¾å‡†æŠ•é€’ï¼Œæ— å†—ä½™æ¶ˆæ¯
  - ç™¾ä¸‡è®¾å¤‡è§„æ¨¡ä¸‹ï¼Œå®é™…æ´»è·ƒé¢‘é“å¾ˆå°‘ï¼ˆå‡ ååˆ°å‡ ç™¾ï¼‰
  - Redis å¯¹æ— è®¢é˜…è€…çš„é¢‘é“å‡ ä¹æ— å¼€é”€

**æ¶ˆæ¯æ ¼å¼**:
```json
{
  "device_id": "xxx",
  "device_name": "æ¸©åº¦ä¼ æ„Ÿå™¨01",
  "is_online": true,
  "timestamp": 1697452800,
  "source": "status_message"
}
```

#### 2. WebSocket å¤„ç†æµç¨‹

**è¿æ¥å»ºç«‹**:
```
1. WebSocket æ¡æ‰‹
2. è§£æè¯·æ±‚å‚æ•° (device_id)
3. éªŒè¯æƒé™
4. æŸ¥è¯¢å½“å‰çŠ¶æ€ (æ•°æ®åº“/ç¼“å­˜) â†’ ç«‹å³è¿”å›
5. è®¢é˜… Redis channel: device:{id}:status
6. è¿›å…¥æ¶ˆæ¯å¾ªç¯
```

**æ¶ˆæ¯å¤„ç†**:
```
goroutine 1: 
  - ä» Redis Pub/Sub æ¥æ”¶æ¶ˆæ¯
  - è½¬å‘åˆ° WebSocket è¿æ¥

goroutine 2:
  - å¤„ç† WebSocket å¿ƒè·³ (ping/pong)
  - æ£€æµ‹è¿æ¥æ–­å¼€
```

**è¿æ¥å…³é—­**:
```
1. å–æ¶ˆ Redis è®¢é˜…
2. æ¸…ç†èµ„æº
3. å…³é—­ WebSocket
```

---

## ğŸ”§ å®ç°è¦ç‚¹

### 1. StatusFlow æ‰©å±•

åœ¨ `internal/flow/status.go` çš„ `processMessage()` ä¸­ï¼š

```go
func (f *StatusFlow) processMessage(msg *DeviceMessage) {
    // ... åŸæœ‰é€»è¾‘ ...
    
    // æ›´æ–°æ•°æ®åº“
    dal.UpdateDeviceStatus(device.ID, status)
    
    // ğŸ†• å‘å¸ƒåˆ° Redis
    f.publishToRedis(device, status, msg.Metadata["source"])
    
    // ... SSEã€è‡ªåŠ¨åŒ–ç­‰å…¶ä»–é€»è¾‘ ...
}

func (f *StatusFlow) publishToRedis(device *model.Device, status int16, source interface{}) {
    ctx := context.Background()
    channel := fmt.Sprintf("device:%s:status", device.ID)
    
    payload := map[string]interface{}{
        "device_id":   device.ID,
        "device_name": getDeviceName(device),
        "is_online":   status == 1,
        "timestamp":   time.Now().Unix(),
        "source":      source,
    }
    
    jsonData, _ := json.Marshal(payload)
    global.REDIS.Publish(ctx, channel, jsonData)
}
```

**è¦ç‚¹**:
- å‘å¸ƒæ“ä½œå¼‚æ­¥åŒ–ï¼ˆé¿å…é˜»å¡ï¼‰
- ä½¿ç”¨è¿æ¥æ± ï¼ˆé¿å…é¢‘ç¹åˆ›å»ºè¿æ¥ï¼‰
- é”™è¯¯å¤„ç†ï¼ˆå‘å¸ƒå¤±è´¥è®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä¸»æµç¨‹ï¼‰

### 2. WebSocket Handler é‡æ„

åœ¨ `internal/api/telemetry_data.go` ä¸­ï¼š

```go
func (*TelemetryDataApi) ServeDeviceStatusByWS(c *gin.Context) {
    // 1. WebSocket æ¡æ‰‹
    conn, err := Wsupgrader.Upgrade(c.Writer, c.Request, nil)
    if err != nil {
        return
    }
    defer conn.Close()
    
    // 2. è§£æè®¾å¤‡IDå’Œè®¤è¯
    deviceID, claims, err := parseWSRequest(conn)
    if err != nil {
        return
    }
    
    // 3. ç«‹å³æŸ¥è¯¢å¹¶è¿”å›å½“å‰çŠ¶æ€
    currentStatus := getCurrentDeviceStatus(deviceID)
    conn.WriteMessage(websocket.TextMessage, currentStatus)
    
    // 4. è®¢é˜… Redis
    ctx, cancel := context.WithCancel(context.Background())
    defer cancel()
    
    channel := fmt.Sprintf("device:%s:status", deviceID)
    pubsub := global.REDIS.Subscribe(ctx, channel)
    defer pubsub.Close()
    
    // 5. å¯åŠ¨ä¸¤ä¸ª goroutine
    var wg sync.WaitGroup
    wg.Add(2)
    
    // goroutine 1: Redis â†’ WebSocket
    go func() {
        defer wg.Done()
        for {
            msg, err := pubsub.ReceiveMessage(ctx)
            if err != nil {
                return
            }
            conn.WriteMessage(websocket.TextMessage, []byte(msg.Payload))
        }
    }()
    
    // goroutine 2: å¤„ç† WebSocket å¿ƒè·³
    go func() {
        defer wg.Done()
        defer cancel() // è§¦å‘ goroutine 1 é€€å‡º
        
        for {
            _, msg, err := conn.ReadMessage()
            if err != nil {
                return
            }
            if string(msg) == "ping" {
                conn.WriteMessage(websocket.TextMessage, []byte("pong"))
            }
        }
    }()
    
    wg.Wait()
}
```

**è¦ç‚¹**:
- ç«‹å³è¿”å›å½“å‰çŠ¶æ€ï¼ˆç”¨æˆ·ä½“éªŒï¼‰
- ä¼˜é›…é€€å‡ºï¼ˆgoroutine åŒæ­¥ï¼‰
- é”™è¯¯å¤„ç†ï¼ˆè¿æ¥æ–­å¼€ã€è®¢é˜…å¤±è´¥ï¼‰
- æ”¯æŒå¿ƒè·³ä¿æ´»

### 3. åˆ é™¤æ—§ä»£ç 

**ç§»é™¤**:
- `mqtt/ws_subscribe/mqtt_client.go` ä¸­çš„ `SubscribeOnlineOffline()` æ–¹æ³•
- æˆ–æ•´ä¸ª `ws_subscribe` åŒ…ï¼ˆå¦‚æœåªç”¨äºçŠ¶æ€è®¢é˜…ï¼‰

**ä¿ç•™**:
- é¥æµ‹æ•°æ®çš„ WebSocket è®¢é˜…ï¼ˆå¦‚æœè¿˜åœ¨ç”¨ MQTT æ–¹å¼ï¼‰
- å¯ä»¥åç»­ç”¨åŒæ ·æ€è·¯ä¼˜åŒ–

---

## ğŸ“ˆ æ–¹æ¡ˆä¼˜åŠ¿

### 1. æ¶æ„ä¸€è‡´æ€§

| æ–¹é¢ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| **æ•°æ®æº** | ç›´æ¥è®¢é˜… MQTT | ç»Ÿä¸€ä» Flow å±‚ |
| **æ¨¡å¼æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… å®Œæ•´æ”¯æŒä¸‰ç§æ¨¡å¼ |
| **Kafka æ”¯æŒ** | âŒ æ— æ³•å¤„ç† | âœ… è‡ªåŠ¨æ”¯æŒ |
| **é€»è¾‘åˆ†æ•£** | âš ï¸ ä¸¤å¤„ | âœ… å•ä¸€æ•°æ®æº |

### 2. æ€§èƒ½å’Œèµ„æº

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| **MQTT è¿æ¥** | N ä¸ªï¼ˆN=WSæ•°é‡ï¼‰ | 1 ä¸ªï¼ˆç»Ÿä¸€è®¢é˜…å±‚ï¼‰ |
| **Redis è®¢é˜…** | 0 | N ä¸ªï¼ˆä½† N å¾ˆå°ï¼‰ |
| **æ¶ˆæ¯å»¶è¿Ÿ** | ~10ms | ~5msï¼ˆRedis æ›´å¿«ï¼‰ |
| **é›†ç¾¤æ”¯æŒ** | âš ï¸ éœ€è¦å…±äº«è®¢é˜… | âœ… åŸç”Ÿæ”¯æŒ |

### 3. å¯æ‰©å±•æ€§

- âœ… æ”¯æŒä»»æ„æ•°æ®æºï¼ˆMQTT/Kafka/HTTP/...ï¼‰
- âœ… æ”¯æŒæ°´å¹³æ‰©å±•ï¼ˆå¤šå®ä¾‹ï¼‰
- âœ… ç»Ÿä¸€ç›‘æ§å’Œè°ƒè¯•
- âœ… åç»­åŠŸèƒ½æ˜“äºæ·»åŠ 

---

## ğŸ¯ å®æ–½æ­¥éª¤

### Phase 1: StatusFlow æ‰©å±•ï¼ˆ1-2å°æ—¶ï¼‰

1. åœ¨ `StatusFlow` æ·»åŠ  `publishToRedis()` æ–¹æ³•
2. åœ¨ `processMessage()` ä¸­è°ƒç”¨å‘å¸ƒ
3. é…ç½® Redis å®¢æˆ·ç«¯ï¼ˆå¤ç”¨ç°æœ‰è¿æ¥ï¼‰
4. æµ‹è¯•å‘å¸ƒåŠŸèƒ½ï¼ˆå¯ä»¥ç”¨ redis-cli éªŒè¯ï¼‰

### Phase 2: WebSocket Handler é‡æ„ï¼ˆ2-3å°æ—¶ï¼‰

1. é‡å†™ `ServeDeviceStatusByWS()` å‡½æ•°
2. æ·»åŠ  Redis è®¢é˜…é€»è¾‘
3. å¤„ç† goroutine åŒæ­¥å’Œé”™è¯¯
4. æ·»åŠ æ—¥å¿—å’Œç›‘æ§

### Phase 3: æµ‹è¯•éªŒè¯ï¼ˆ2-4å°æ—¶ï¼‰

1. å•å®ä¾‹æµ‹è¯•
   - è®¾å¤‡ä¸Šçº¿/ä¸‹çº¿
   - WebSocket æ­£å¸¸æ¥æ”¶
   - å¿ƒè·³ä¿æ´»

2. é›†ç¾¤æµ‹è¯•
   - å¤šå®ä¾‹éƒ¨ç½²
   - è·¨å®ä¾‹æ¶ˆæ¯ä¼ é€’
   - è´Ÿè½½å‡è¡¡

3. ä¸‰ç§æ¨¡å¼æµ‹è¯•
   - æ— é…ç½®æ¨¡å¼
   - å¿ƒè·³æ¨¡å¼
   - è¶…æ—¶æ¨¡å¼

### Phase 4: æ¸…ç†æ—§ä»£ç ï¼ˆ30åˆ†é’Ÿï¼‰

1. åˆ é™¤ `SubscribeOnlineOffline()` æ–¹æ³•
2. æ¸…ç†ç›¸å…³å¯¼å…¥
3. æ›´æ–°æ–‡æ¡£

---

## ğŸ” è¾¹ç•Œæƒ…å†µå¤„ç†

### 1. WebSocket æ–­çº¿é‡è¿

**åœºæ™¯**: å‰ç«¯åˆ·æ–°é¡µé¢ï¼ŒWebSocket é‡è¿

**å¤„ç†**:
- é‡æ–°æŸ¥è¯¢å½“å‰çŠ¶æ€ï¼ˆå¯èƒ½å·²å˜åŒ–ï¼‰
- é‡æ–°è®¢é˜… Redis
- ä¸ä¼šä¸¢å¤±çŠ¶æ€ï¼ˆæ€»èƒ½æ‹¿åˆ°æœ€æ–°çš„ï¼‰

### 2. Redis è¿æ¥å¤±è´¥

**é™çº§æ–¹æ¡ˆ**:
```go
if err := pubsub.Subscribe(...); err != nil {
    // è®°å½•é”™è¯¯
    logrus.Error("Redis subscribe failed, falling back to polling")
    
    // é™çº§ä¸ºè½®è¯¢æ¨¡å¼ï¼ˆæ¯5ç§’æŸ¥ä¸€æ¬¡æ•°æ®åº“ï¼‰
    ticker := time.NewTicker(5 * time.Second)
    // ...
}
```

### 3. è®¾å¤‡çŠ¶æ€åœ¨è®¢é˜…å‰å˜åŒ–

**é—®é¢˜**: æŸ¥è¯¢çŠ¶æ€ â†’ çŠ¶æ€å˜åŒ– â†’ è®¢é˜… Redisï¼ˆä¸¢å¤±è¿™ä¸€æ¬¡å˜åŒ–ï¼‰

**è§£å†³**:
- å¯æ¥å—ï¼šä¸‹æ¬¡å˜åŒ–ä¼šæ”¶åˆ°
- æˆ–è€…ï¼šè®¢é˜…åå†æŸ¥ä¸€æ¬¡çŠ¶æ€å¯¹æ¯”

### 4. æ¶ˆæ¯é¡ºåºæ€§

**Redis Pub/Sub ä¸ä¿è¯é¡ºåº**ï¼ˆè™½ç„¶å®é™…ä¸ŠåŸºæœ¬æœ‰åºï¼‰

**å¤„ç†**:
- å‰ç«¯æ ¹æ® `timestamp` åˆ¤æ–­
- æˆ–è€…åç«¯å‘é€æ—¶å¸¦åºå·

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

å»ºè®®æ·»åŠ çš„æŒ‡æ ‡ï¼š

```go
// Prometheus metrics
var (
    redisPublishTotal = prometheus.NewCounter(...)
    redisPublishErrors = prometheus.NewCounter(...)
    wsConnectionsActive = prometheus.NewGauge(...)
    wsMessagesSent = prometheus.NewCounter(...)
)
```

å…³é”®æŒ‡æ ‡ï¼š
- Redis å‘å¸ƒæˆåŠŸ/å¤±è´¥æ¬¡æ•°
- æ´»è·ƒ WebSocket è¿æ¥æ•°
- æ¶ˆæ¯æ¨é€å»¶è¿Ÿ
- è®¢é˜…é¢‘é“æ•°é‡

---

## ğŸ’¡ åç»­ä¼˜åŒ–æ–¹å‘

### 1. é¥æµ‹æ•°æ® WebSocket

å¯ä»¥ç”¨åŒæ ·æ€è·¯ä¼˜åŒ–ï¼š
- StatusFlow å‘å¸ƒçŠ¶æ€åˆ° Redis
- TelemetryFlow å‘å¸ƒé¥æµ‹åˆ° Redis
- WebSocket ç»Ÿä¸€ä» Redis è®¢é˜…

### 2. æ‰¹é‡è®¢é˜…

å¦‚æœå°†æ¥éœ€è¦è®¾å¤‡åˆ—è¡¨é¡µï¼š
```go
// è®¢é˜…æ¨¡å¼ï¼šdevice:*:status
// ä½†éœ€è¦è¿‡æ»¤ tenant_id
```

### 3. æ¶ˆæ¯å‹ç¼©

å¦‚æœæ¶ˆæ¯é‡å¤§ï¼š
- ä½¿ç”¨ MessagePack æ›¿ä»£ JSON
- æˆ–è€…ä½¿ç”¨ gzip å‹ç¼©

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæ”¹åŠ¨

1. âœ… StatusFlow å‘å¸ƒåˆ° Redis (`device:{id}:status`)
2. âœ… WebSocket è®¢é˜… Redisï¼ˆè€Œé MQTTï¼‰
3. âœ… åˆ é™¤ `SubscribeOnlineOffline()` æ—§é€»è¾‘

### å…³é”®ä¼˜åŠ¿

- âœ… æ•°æ®ç»Ÿä¸€ä» Flow å±‚å‡ºæ¥
- âœ… æ”¯æŒä¸‰ç§æ¨¡å¼
- âœ… æ”¯æŒé›†ç¾¤éƒ¨ç½²
- âœ… æ”¯æŒå¤šæ•°æ®æºï¼ˆKafka/MQTTï¼‰
- âœ… æ¶æ„æ¸…æ™°æ˜“ç»´æŠ¤

### å·¥ä½œé‡è¯„ä¼°

- å¼€å‘æ—¶é—´: 4-6 å°æ—¶
- æµ‹è¯•æ—¶é—´: 2-4 å°æ—¶
- æ€»è®¡: 1 ä¸ªå·¥ä½œæ—¥

### é£é™©è¯„ä¼°

- é£é™©: ä½
- å›æ»šæ–¹æ¡ˆ: ä¿ç•™æ—§ä»£ç ï¼Œé…ç½®å¼€å…³æ§åˆ¶
- å…¼å®¹æ€§: å‰ç«¯æ— éœ€æ”¹åŠ¨

---

**å»ºè®®**: ä¼˜å…ˆå®æ–½æ­¤ä¼˜åŒ–ï¼Œå¯¹ç°æœ‰æ¶æ„æ˜¯é‡è¦çš„è¡¥å……å®Œå–„ã€‚
