# MVP è®¾å¤‡è¯Šæ–­é¢æ¿ - éœ€æ±‚æ–‡æ¡£

## ä¸€ã€é¢æ¿å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡è¯Šæ–­ - device_smart_meter_001                      [åˆ·æ–°] âŸ³  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ğŸ“Š ç´¯è®¡ç»Ÿè®¡æ¦‚è§ˆ                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  ä¸Šè¡ŒæˆåŠŸç‡   â”‚  ä¸‹è¡ŒæˆåŠŸç‡   â”‚  å­˜å‚¨æˆåŠŸç‡   â”‚                 â”‚
â”‚  â”‚              â”‚              â”‚              â”‚                 â”‚
â”‚  â”‚    98.5%    â”‚    100%     â”‚    98.8%    â”‚                 â”‚
â”‚  â”‚   â”â”â”â”â”â”â”   â”‚   â”â”â”â”â”â”â”   â”‚   â”â”â”â”â”â”â”   â”‚                 â”‚
â”‚  â”‚  850/863æ¡  â”‚  500/500æ¡  â”‚  852/863æ¡  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚  â“˜ ç»Ÿè®¡èŒƒå›´ï¼šå¯åŠ¨è‡³ä»Š                                             â”‚
â”‚                                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âŒ æœ€è¿‘å¤±è´¥è®°å½•ï¼ˆæœ€å¤š5æ¡ï¼‰                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ—¶é—´          æ–¹å‘    é˜¶æ®µ        é”™è¯¯æè¿°                   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ 14:32:15     ä¸Šè¡Œ    Processor   è§£ç è¶…æ—¶ï¼šè„šæœ¬æ‰§è¡Œ>5s      â”‚ â”‚
â”‚  â”‚ 14:30:42     ä¸Šè¡Œ    Storage     å­˜å‚¨å¤±è´¥ï¼šè¿æ¥è¶…æ—¶         â”‚ â”‚
â”‚  â”‚ 14:28:10     ä¸‹è¡Œ    Publish     MQTTå‘å¸ƒå¤±è´¥ï¼šè¿æ¥æ–­å¼€     â”‚ â”‚
â”‚  â”‚ 14:25:33     ä¸Šè¡Œ    Adapter     æ¶ˆæ¯æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘å­—æ®µ      â”‚ â”‚
â”‚  â”‚ 14:20:08     ä¸‹è¡Œ    Encode      è„šæœ¬æœªæ‰¾åˆ°ï¼šscript_v2      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ ¸å¿ƒæŒ‡æ ‡

|æŒ‡æ ‡åç§°|è®¡ç®—å…¬å¼|è¯´æ˜|
|:-:|:-:|:-:|
|**ä¸Šè¡ŒæˆåŠŸç‡**|`(uplink_total - uplink_failed) / uplink_total Ã— 100%`|æ¶ˆæ¯å¤„ç†æˆåŠŸç‡ï¼ˆAdapter + Processorï¼‰|
|**ä¸‹è¡ŒæˆåŠŸç‡**|`(downlink_total - downlink_failed) / downlink_total Ã— 100%`|æŒ‡ä»¤ä¸‹å‘æˆåŠŸç‡|
|**å­˜å‚¨æˆåŠŸç‡**|`(uplink_total - storage_failed) / uplink_total Ã— 100%`|æ•°æ®å…¥åº“æˆåŠŸç‡|

---

## ä¸‰ã€æ•°æ®é‡‡é›†è§„åˆ™

### ç»Ÿè®¡æ—¶æœº

|äº‹ä»¶|ç»Ÿè®¡åŠ¨ä½œ|
|:-:|:-:|
|**å¤„ç†æ¶ˆæ¯æ—¶**|`uplink_total + 1`|
|**å¤„ç†å¤±è´¥æ—¶**|`uplink_failed + 1` + è®°å½•åˆ°å¤±è´¥åˆ—è¡¨|
|**å­˜å‚¨å¤±è´¥æ—¶**|`storage_failed + 1` + è®°å½•åˆ°å¤±è´¥åˆ—è¡¨ï¼ˆæ¯æ¡å¤±è´¥è®°å½•åˆ°å¯¹åº”è®¾å¤‡ï¼‰|
|**ä¸‹è¡ŒæŒ‡ä»¤æ—¶**|`downlink_total + 1`|
|**ä¸‹è¡Œå¤±è´¥æ—¶**|`downlink_failed + 1` + è®°å½•åˆ°å¤±è´¥åˆ—è¡¨|

### æšä¸¾å€¼å®šä¹‰

**æ–¹å‘ï¼ˆdirectionï¼‰**
- `uplink`ï¼šä¸Šè¡Œ
- `downlink`ï¼šä¸‹è¡Œ

**é˜¶æ®µï¼ˆstageï¼‰**
- `adapter`ï¼šé€‚é…å™¨ï¼ˆæ¶ˆæ¯æ ¼å¼éªŒè¯ï¼‰
- `processor`ï¼šå¤„ç†å™¨ï¼ˆè„šæœ¬è§£ç /ç¼–ç ï¼‰
- `storage`ï¼šå­˜å‚¨ï¼ˆæ‰¹é‡å†™å…¥ï¼‰
- `encode`ï¼šç¼–ç ï¼ˆä¸‹è¡Œè„šæœ¬ç¼–ç ï¼‰
- `publish`ï¼šå‘å¸ƒï¼ˆMQTT å‘å¸ƒï¼‰

---

## å››ã€æ•°æ®å­˜å‚¨æ–¹æ¡ˆ

### Redis ç»“æ„

```
# ç»Ÿè®¡æŒ‡æ ‡ï¼ˆHashï¼‰
Key: device:{device_id}:diagnostics:stats
Fields:
  - uplink_total: ä¸Šè¡Œæ¶ˆæ¯æ€»æ•°
  - uplink_failed: ä¸Šè¡Œå¤„ç†å¤±è´¥æ•°
  - storage_failed: å­˜å‚¨å¤±è´¥æ•°
  - downlink_total: ä¸‹è¡ŒæŒ‡ä»¤æ€»æ•°
  - downlink_failed: ä¸‹è¡Œå¤±è´¥æ•°

# å¤±è´¥è®°å½•ï¼ˆListï¼Œä¿ç•™æœ€æ–°5æ¡ï¼‰
Key: device:{device_id}:diagnostics:failures
Value: JSON å­—ç¬¦ä¸² {"timestamp":"...","direction":"...","stage":"...","error":"..."}
```

### æ‰¹é‡å†™å…¥å¤±è´¥å¤„ç†

**å…³é”®åŸåˆ™**ï¼šæ‰¹é‡å†™å…¥å¯èƒ½åŒ…å«å¤šä¸ªè®¾å¤‡çš„æ•°æ®ï¼Œæ¯æ¡å¤±è´¥è®°å½•å¿…é¡»è®°å½•åˆ°**å¯¹åº”çš„è®¾å¤‡**ä¸Šã€‚

1. **æ‰¹é‡å†™å…¥æ•´ä½“å¤±è´¥**ï¼š
   - `batchInsert` å¤±è´¥æ—¶ï¼Œè§¦å‘ `fallbackInsert` é™çº§é€æ¡æ’å…¥
   - `fallbackInsert` é€æ¡å¤„ç†ï¼Œæ¯æ¡æ•°æ®éƒ½æœ‰å¯¹åº”çš„ `device_id`

2. **é€æ¡å†™å…¥å¤±è´¥**ï¼š
   - åœ¨ `fallbackInsert` ä¸­ï¼Œæ¯æ¡å¤±è´¥å•ç‹¬è®°å½•åˆ°å¯¹åº”è®¾å¤‡çš„è¯Šæ–­æ•°æ®
   - **ç»Ÿè®¡**ï¼š`device_id` çš„ `storage_failed += 1`
   - **è¯Šæ–­è®°å½•**ï¼šè®°å½•åˆ° `device_id` çš„å¤±è´¥åˆ—è¡¨ï¼Œerror åŒ…å«å…·ä½“é”™è¯¯ä¿¡æ¯
   - **ç¤ºä¾‹**ï¼š`{"timestamp":"...","direction":"uplink","stage":"storage","error":"å­˜å‚¨å¤±è´¥ï¼šè¿æ¥è¶…æ—¶"}`

3. **å®ç°è¦ç‚¹**ï¼š
   - åœ¨ `fallbackInsert` çš„å¤±è´¥åˆ†æ”¯ï¼Œè°ƒç”¨è¯Šæ–­æ”¶é›†å™¨è®°å½•å¤±è´¥
   - ä¼ å…¥å¯¹åº”çš„ `device_id`ï¼Œç¡®ä¿è®°å½•åˆ°æ­£ç¡®çš„è®¾å¤‡

---

## äº”ã€API æ¥å£

### è¯·æ±‚
```
GET /api/devices/{device_id}/diagnostics
```

### å“åº”
```json
{
  "device_id": "device_smart_meter_001",
  "stats": {
    "uplink": {
      "success_rate": 98.5,
      "total": 863,
      "success": 850
    },
    "downlink": {
      "success_rate": 100,
      "total": 500,
      "success": 500
    },
    "storage": {
      "success_rate": 98.8,
      "total": 863,
      "success": 852
    }
  },
  "recent_failures": [
    {
      "timestamp": "2025-10-31T14:32:15Z",
      "direction": "uplink",
      "stage": "processor",
      "error": "è§£ç è¶…æ—¶ï¼šè„šæœ¬æ‰§è¡Œ>5s"
    },
    {
      "timestamp": "2025-10-31T14:30:42Z",
      "direction": "uplink",
      "stage": "storage",
      "error": "å­˜å‚¨å¤±è´¥ï¼šè¿æ¥è¶…æ—¶"
    }
  ]
}
```

**æ³¨æ„**ï¼šè¯Šæ–­æ¥å£æš‚ä¸æ ¡éªŒæƒé™ã€‚

---

## å…­ã€ç©ºæ€å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡è¯Šæ–­ - device_new_sensor_999                       [åˆ·æ–°] âŸ³  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ğŸ“Š ç´¯è®¡ç»Ÿè®¡æ¦‚è§ˆ                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  ä¸Šè¡ŒæˆåŠŸç‡   â”‚  ä¸‹è¡ŒæˆåŠŸç‡   â”‚  å­˜å‚¨æˆåŠŸç‡   â”‚                 â”‚
â”‚  â”‚              â”‚              â”‚              â”‚                 â”‚
â”‚  â”‚      -      â”‚      -      â”‚      -      â”‚                 â”‚
â”‚  â”‚   â”â”â”â”â”â”â”   â”‚   â”â”â”â”â”â”â”   â”‚   â”â”â”â”â”â”â”   â”‚                 â”‚
â”‚  â”‚   æš‚æ— æ•°æ®   â”‚   æš‚æ— æ•°æ®   â”‚   æš‚æ— æ•°æ®   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚  â“˜ è¯¥è®¾å¤‡å°šæœªäº§ç”Ÿæ¶ˆæ¯è®°å½•                                         â”‚
â”‚                                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âŒ æœ€è¿‘å¤±è´¥è®°å½•                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚                      ğŸ“­                                     â”‚ â”‚
â”‚  â”‚                   æš‚æ— å¤±è´¥è®°å½•                               â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡

é‡‡ç”¨**ç»Ÿä¸€è¯Šæ–­æœåŠ¡æ¨¡å¼**ï¼ˆDiagnostics Collectorï¼‰ï¼Œåˆ›å»ºç‹¬ç«‹æ¨¡å—ç»Ÿä¸€æ”¶é›†ç»Ÿè®¡æ•°æ®å’Œå¤±è´¥è®°å½•ã€‚

```
internal/
  diagnostics/
    collector.go      # ç»Ÿä¸€æ”¶é›†å™¨ï¼ˆå•ä¾‹ï¼Œå¼‚æ­¥ç¼“å†²ï¼‰
    metrics.go       # Redis æ“ä½œå°è£…
    types.go         # æ•°æ®ç»“æ„å®šä¹‰
```

**ä¼˜åŠ¿**ï¼š
- èŒè´£æ¸…æ™°ï¼Œä¸å½±å“ä¸šåŠ¡ä»£ç 
- æ˜“äºæ‰©å±•å’Œç»´æŠ¤
- æ€§èƒ½å½±å“å°ï¼ˆå¼‚æ­¥ç¼“å†²å†™å…¥ï¼‰

### ä¾èµ–å…³ç³»åˆ†æï¼ˆé¿å…å¾ªç¯å¯¼å…¥ï¼‰

**âœ… ä¸ä¼šå½¢æˆå¾ªç¯å¯¼å…¥**

ä¾èµ–é“¾å¦‚ä¸‹ï¼š
```
diagnostics â†’ pkg/global â†’ (ä»…æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“)
storage/uplink/adapter/downlink â†’ diagnostics (å•å‘)
api â†’ diagnostics (å•å‘)
```

**å…³é”®ç‚¹**ï¼š
1. `diagnostics` åªä¾èµ–ï¼š
   - æ ‡å‡†åº“ï¼ˆ`encoding/json`, `sync`, `time` ç­‰ï¼‰
   - `pkg/global`ï¼ˆè®¿é—® `global.REDIS`ï¼‰
   - `github.com/redis/go-redis/v9`
   
2. `pkg/global` åªä¾èµ–ï¼š
   - `internal/middleware/response`ï¼ˆé€šç”¨ä¸­é—´ä»¶ï¼Œä¸æ¶‰åŠä¸šåŠ¡æ¨¡å—ï¼‰

3. ä¸šåŠ¡æ¨¡å—ï¼ˆ`storage`/`uplink`/`adapter`/`downlink`ï¼‰é€šè¿‡å¯¼å…¥ `diagnostics` ä½¿ç”¨ï¼Œä¸ä¼šå½¢æˆåå‘ä¾èµ–

**ç»“è®º**ï¼šä¾èµ–å…³ç³»æ˜¯**å•å‘çš„ã€æ— ç¯çš„**ï¼Œä¸ä¼šå‡ºç°å¾ªç¯å¯¼å…¥é—®é¢˜ã€‚

### åŸ‹ç‚¹ä½ç½®

**ä¸Šè¡Œé“¾è·¯**ï¼š
1. `adapter/mqttadapter/adapter.go`:
   - `HandleTelemetryMessage`: éªŒè¯å¤±è´¥ â†’ `direction: uplink, stage: adapter`
   - `HandleAttributeMessage`: éªŒè¯å¤±è´¥ â†’ `direction: uplink, stage: adapter`
   - `HandleEventMessage`: éªŒè¯å¤±è´¥ â†’ `direction: uplink, stage: adapter`

2. `uplink/telemetry.go`, `attribute.go`, `event.go`:
   - `processor.Decode` å¤±è´¥ â†’ `direction: uplink, stage: processor`
   - å‘é€åˆ° storage å‰ â†’ `uplink_total + 1`

3. `storage/telemetry_writer.go`:
   - `fallbackInsert` é€æ¡å¤±è´¥ â†’ `direction: uplink, stage: storage`ï¼ˆæ¯æ¡å¤±è´¥è®°å½•åˆ°å¯¹åº”è®¾å¤‡ï¼‰

**ä¸‹è¡Œé“¾è·¯**ï¼š
1. `downlink/handler.go`:
   - `encode` å¤±è´¥ â†’ `direction: downlink, stage: encode`
   - `publish` å¤±è´¥ â†’ `direction: downlink, stage: publish`
   - å¤„ç†å¼€å§‹æ—¶ â†’ `downlink_total + 1`

### é…ç½®è®¾è®¡

åœ¨ `configs/conf.yml` ä¸­æ·»åŠ ï¼š

```yaml
diagnostics:
  enabled: true          # æ˜¯å¦å¯ç”¨è®¾å¤‡è¯Šæ–­ï¼ˆå…³é—­æ—¶ä¸å¯åŠ¨ç›‘æ§ï¼‰
  max_failures: 5        # ä¿ç•™å¤±è´¥è®°å½•æ•°
  batch_flush_size: 10   # æ‰¹é‡åˆ·æ–°å¤§å°ï¼ˆå¼‚æ­¥ç¼“å†²ï¼‰
  batch_flush_interval: 1s  # æ‰¹é‡åˆ·æ–°é—´éš”
  persist_to_db: false   # æ˜¯å¦æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼ˆæœåŠ¡é‡å¯åä¿ç•™ï¼‰
```

### æŠ€æœ¯çº¦æŸ

1. **ç»Ÿè®¡æ–¹å¼**ï¼šç´¯è®¡è®¡æ•°ï¼ˆæœåŠ¡å¯åŠ¨è‡³ä»Šï¼‰ï¼Œé‡å¯æ¸…é›¶ï¼ˆå¯é…ç½®æŒä¹…åŒ–ï¼‰
2. **å­˜å‚¨æ–¹æ¡ˆ**ï¼šRedisï¼ˆHash + Listï¼‰
3. **å¹¶å‘å®‰å…¨**ï¼šä½¿ç”¨ Redis åŸå­æ“ä½œï¼ˆ`HINCRBY`ã€`LPUSH` + `LTRIM`ï¼‰
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¼‚æ­¥ç¼“å†²æ‰¹é‡å†™å…¥ï¼Œä¸é˜»å¡ä¸šåŠ¡å¤„ç†
5. **å¼€å…³æ§åˆ¶**ï¼šé…ç½® `enabled: false` æ—¶å®Œå…¨å…³é—­è¯Šæ–­åŠŸèƒ½

---

## å…«ã€å®æ–½æ­¥éª¤

1. âœ… åˆ›å»º `internal/diagnostics` æ¨¡å—
2. âœ… å®ç°æ”¶é›†å™¨ï¼ˆå•ä¾‹ï¼Œå¼‚æ­¥ç¼“å†²ï¼‰
3. âœ… åœ¨å…³é”®ä½ç½®åŸ‹ç‚¹ï¼ˆ6-8 å¤„ï¼‰
4. âœ… æ·»åŠ é…ç½®å¼€å…³ï¼ˆ`diagnostics.enabled`ï¼‰
5. âœ… å®ç° API æ¥å£ `GET /api/devices/{device_id}/diagnostics`ï¼ˆä¸æ ¡éªŒæƒé™ï¼‰
6. âœ… é›†æˆåˆ°åº”ç”¨å¯åŠ¨æµç¨‹ï¼ˆæ£€æŸ¥å¼€å…³ï¼‰

---

## ä¹ã€MVP èŒƒå›´

- âœ… ç´¯è®¡ç»Ÿè®¡ï¼ˆå¯åŠ¨è‡³ä»Šï¼‰
- âœ… ä¸‰ä¸ªæ ¸å¿ƒæŒ‡æ ‡ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œ/å­˜å‚¨æˆåŠŸç‡ï¼‰
- âœ… æœ€è¿‘5æ¡å¤±è´¥è®°å½•
- âœ… æ‰‹åŠ¨åˆ·æ–°
- âœ… é…ç½®å¼€å…³æ§åˆ¶