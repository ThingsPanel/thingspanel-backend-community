# 主题转换变更

## 变更概述

在 `device_topic_mappings` 表中新增 `data_identifier` 字段，用于标识主题转换规则对应的数据标识符。该字段允许更精确的主题转换匹配，特别是在处理设备遥测、属性、事件等不同类型数据时。

## 数据库变更

### SQL 脚本

```sql
-- ✅2025/12/10 设备主题转换表添加数据标识符字段
ALTER TABLE public.device_topic_mappings ADD data_identifier varchar(500) NULL;
```

### 字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| data_identifier | varchar(500) | 数据标识符，可选字段。用于标识该主题转换规则对应的数据标识符（如遥测、属性、事件、命令的标识符） |

## 接口变更

### 1. 创建主题转换接口

**请求参数新增**：

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| data_identifier | string | 否 | 数据标识符，最大长度500 | `temperature` |

**请求体示例**：

```json
{
  "device_config_id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "上行遥测主题转换",
  "direction": "up",
  "source_topic": "{device_number}/data/+",
  "target_topic": "devices/telemetry/{device_number}/+",
  "priority": 10,
  "enabled": true,
  "description": "将设备原始主题转换为平台规范主题",
  "data_identifier": "temperature"
}
```

### 2. 更新主题转换接口

**请求参数新增**：

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| data_identifier | string | 否 | 数据标识符，最大长度500 | `temperature` |

### 3. 获取主题转换列表接口

**请求参数新增**（可选筛选条件）：

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| data_identifier | string | 否 | 数据标识符，精确匹配 | `temperature` |

**响应字段新增**：

响应中的每个主题转换规则对象将包含 `data_identifier` 字段：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 10,
    "list": [
      {
        "id": 1,
        "device_config_id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "上行遥测主题转换",
        "direction": "up",
        "source_topic": "{device_number}/data/+",
        "target_topic": "devices/telemetry/{device_number}/+",
        "priority": 10,
        "enabled": true,
        "description": "将设备原始主题转换为平台规范主题",
        "data_identifier": "temperature",
        "created_at": "2025-01-15T10:30:00Z",
        "updated_at": "2025-01-15T10:30:00Z"
      }
    ]
  }
}
```

## 代码变更

### 1. 模型层

- ✅ `internal/model/device_topic_mappings.gen.go` 已包含 `DataIdentifier *string` 字段（自动生成）

### 2. 请求/响应结构体

需要更新以下文件：
- `internal/model/device_topic_mappings.http.go`
  - `CreateDeviceTopicMappingReq` 添加 `DataIdentifier` 字段
  - `UpdateDeviceTopicMappingReq` 添加 `DataIdentifier` 字段
  - `ListDeviceTopicMappingReq` 添加 `DataIdentifier` 筛选字段（可选）

### 3. 服务层

需要更新以下文件：
- `internal/service/device_topic_mapping.go`
  - `CreateDeviceTopicMapping` 方法：处理 `data_identifier` 字段
  - `UpdateDeviceTopicMapping` 方法：支持更新 `data_identifier` 字段

### 4. 数据访问层

需要更新以下文件：
- `internal/dal/device_topic_mapping.go`
  - `ListDeviceTopicMappings` 方法：支持按 `data_identifier` 筛选（可选）

## 缓存影响

**无需变更缓存逻辑**。缓存失效策略保持不变：
- 新增、更新、删除规则时，仍按 `device_config_id` 清除相关缓存
- 缓存 Key 格式不变：`tp:topicmap:up:{device_config_id}`、`tp:topicmap:down:{device_config_id}` 等

## 使用场景

`data_identifier` 字段的主要用途：

1. **精确匹配**：当需要为特定的数据标识符（如 `temperature`、`humidity`）配置专门的主题转换规则时
2. **规则过滤**：在主题转换匹配时，可以结合数据标识符进行更精确的规则选择
3. **业务关联**：将主题转换规则与设备模型中的数据标识符关联，便于管理和维护

## 注意事项

1. `data_identifier` 为可选字段，可以为 `null`，不影响现有功能
2. 该字段主要用于业务层面的标识，不影响主题转换的核心匹配逻辑
3. 建议在需要区分不同数据类型的主题转换时使用此字段