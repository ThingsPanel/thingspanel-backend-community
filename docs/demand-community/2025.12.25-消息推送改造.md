# 消息推送改造需求

## 背景
当前系统只支持告警推送手机端，需要扩展到完整的通知系统中。

## 当前实现
- 已有的手机端推送基础设施：`message_push_manage`、`message_push_config`、`message_push_log` 表
- 推送服务接口：支持通过 push_id 发送推送消息
- **原有告警推送逻辑**：设备告警触发时直接调用推送服务（将被废弃）
- **通知系统**：支持邮件、短信等传统通知方式，但暂不支持手机推送

## 改造目标
取消原有的告警推送方式，统一通过通知系统处理手机端推送，将所有通知场景（包括告警）纳入统一的推送框架。

## 具体需求

### 1. 扩展通知类型
在 `notification_groups` 表的 `notification_type` 字段中增加 `APP` 类型。
- 支持多种通知类型组合，如：`EMAIL,APP`、`SMS,APP`、`WEBHOOK,APP`
- 当通知类型包含 `APP` 时，执行手机端推送逻辑

### 2. 统一推送触发逻辑
**废弃原有告警推送方式**（`AlarmMessagePushSend` 方法），改为统一通过通知系统处理：

当通知规则触发时，如果通知类型包含 `APP`：
1. 根据租户ID从 `message_push_manage` 表获取所有活跃用户的推送ID
2. 遍历每个用户的推送ID，调用推送服务接口发送通知
3. 记录推送日志到 `message_push_log` 表
4. 更新推送统计信息（成功/失败次数，最后推送时间）

### 3. 迁移告警配置
将现有的告警配置迁移到通知系统：
- 为告警相关的通知组添加 `APP` 通知类型
- 确保告警触发时能通过通知系统发送手机推送

### 3. 推送内容格式
推送消息包含：
- 标题：通知标题
- 内容：通知内容
- 业务标识：如告警ID、设备ID等，便于前端跳转

### 4. 推送服务接口
使用已有的推送服务接口：
- 请求：包含 push_clientid、title、content 等字段
- 响应：返回推送结果状态

## 实现要点
- **废弃原有告警推送代码**：移除 `AlarmMessagePushSend` 方法的直接调用
- 复用现有推送基础设施，不需要重新开发推送服务集成
- 推送逻辑统一到通知系统处理
- 支持多租户，每个租户独立推送配置和用户绑定关系

## 验收标准
1. **原有告警推送被废弃**：不再通过 `AlarmMessagePushSend` 方法直接推送
2. 通知规则配置时可以选择 APP 推送类型
3. 告警触发时通过通知系统发送手机推送（替代原有直接推送）
4. 当通知触发时，能正确推送给对应租户下的所有绑定用户
5. 推送日志正确记录，统计信息准确更新
6. 支持与其他通知类型（如邮件、短信）组合使用


## 推送服务接口交互报文
（请求体）示例
json{
  "push_clientid": "4b604dff1ad10961401e876ec1a42aeb",
  "title": "设备告警",
  "content": "您有一条新消息",
  "alarm_id": "c68528ba-1a14-f566-30ff-4f3b0d098557"
}
（响应体）示例
json{
  "code": 200,
  "msg": "发送成功",
  "data": {
    "data": {
      "RASS_1225_8e90d73eede03ec0b81204baef259ff5": {
        "4b604dff1ad10961401e876ec1a42aeb": "successed_offline"
      }
    }
  },
  "errCode": 0,
  "errMsg": "success"
}