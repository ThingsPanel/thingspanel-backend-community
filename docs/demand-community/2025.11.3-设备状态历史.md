# 设备状态历史记录接口设计

## 需求描述

1. 设备在线/离线状态变化需要持久化存储
2. 提供接口查询设备状态历史记录，支持按设备ID、时间范围查询，支持分页

## 相关模块

- `internal/uplink/status.go` - 状态变化存储逻辑

## 当前表结构

```sql
-- 设备状态历史表
CREATE TABLE device_status_history (
    id BIGSERIAL PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    device_id VARCHAR(36) NOT NULL,
    status SMALLINT NOT NULL,
    change_time TIMESTAMPTZ(6) NOT NULL,
    
    CONSTRAINT fk_device FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE
);

CREATE INDEX idx_tenant_device_time ON device_status_history (tenant_id, device_id, change_time);

COMMENT ON TABLE device_status_history IS '设备状态历史表';
COMMENT ON COLUMN device_status_history.tenant_id IS '租户ID';
COMMENT ON COLUMN device_status_history.device_id IS '设备ID';
COMMENT ON COLUMN device_status_history.status IS '状态: 0-离线 1-在线';
COMMENT ON COLUMN device_status_history.change_time IS '状态变更时间';
```

## 接口设计

### 接口信息

- **路径**: `/api/v1/device/status/history`
- **方法**: `GET`
- **权限**: 需要登录，根据租户权限过滤数据

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| device_id | string | 是 | 设备ID | `550e8400-e29b-41d4-a716-446655440000` |
| start_time | int64 | 否 | 开始时间戳（秒） | `1704067200` |
| end_time | int64 | 否 | 结束时间戳（秒） | `1704153600` |
| page | int | 是 | 页码，从1开始 | `1` |
| page_size | int | 是 | 每页数量，范围1-1000 | `20` |
| status | int16 | 否 | 状态筛选：0-离线，1-在线 | `1` |

**参数说明**：
- `start_time` 和 `end_time` 不传时，查询所有历史记录
- 时间范围建议不超过30天，避免查询过慢
- `status` 为可选参数，用于筛选特定状态的历史记录

### 响应格式

**成功响应** (200):

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "list": [
      {
        "id": 1,
        "tenant_id": "550e8400-e29b-41d4-a716-446655440000",
        "device_id": "660e8400-e29b-41d4-a716-446655440001",
        "status": 1,
        "change_time": "2025-01-15T10:30:00Z"
      }
    ]
  }
}
```

**响应字段说明**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| total | int64 | 总记录数 |
| list | array | 状态历史记录列表 |
| list[].id | int64 | 记录ID |
| list[].tenant_id | string | 租户ID |
| list[].device_id | string | 设备ID |
| list[].status | int16 | 状态：0-离线，1-在线 |
| list[].change_time | string | 状态变更时间（ISO 8601格式） |

**错误响应** (400/500):

```json
{
  "code": 400,
  "message": "参数错误",
  "data": {
    "error": "device_id is required"
  }
}
```

### 示例

**请求示例**：

```
GET /api/v1/device/status/history?device_id=660e8400-e29b-41d4-a716-446655440001&start_time=1704067200&end_time=1704153600&page=1&page_size=20
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 45,
    "list": [
      {
        "id": 1001,
        "tenant_id": "550e8400-e29b-41d4-a716-446655440000",
        "device_id": "660e8400-e29b-41d4-a716-446655440001",
        "status": 1,
        "change_time": "2025-01-15T10:30:00Z"
      },
      {
        "id": 1002,
        "tenant_id": "550e8400-e29b-41d4-a716-446655440000",
        "device_id": "660e8400-e29b-41d4-a716-446655440001",
        "status": 0,
        "change_time": "2025-01-15T10:25:00Z"
      }
    ]
  }
}
```

### 注意事项

1. 接口会根据当前登录用户的租户ID自动过滤数据，只能查询本租户下的设备状态历史
2. 数据按 `change_time` 降序排列（最新的在前）
3. 查询结果中不会包含重复的状态记录（相同状态的连续记录）
4. 建议前端实现时间范围限制，避免一次性查询过大数据量