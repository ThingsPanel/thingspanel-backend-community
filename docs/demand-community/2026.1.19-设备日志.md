# 2026.1.16 - 增加设备调试日志功能（简版方案）

## 1. 目标

只记录“设备与平台交互相关”的 MQTT 日志，便于定位设备接入与上下行消息问题：
- 鉴权（auth）
- 订阅（subscribe）
- 发布（publish）
- 上行（device → 平台）
- 下行（平台 → device）

## 2. 记录范围（只做这些）

仅在设备开启“调试模式”期间记录：

1) **鉴权日志**
- 成功/失败、失败原因（不记录明文密码）

2) **订阅日志**
- 订阅主题、允许/拒绝、拒绝原因（白名单拒绝 / 自定义下行映射放行等）

3) **发布日志（上行）**
- 设备发布主题、允许/拒绝
- 若命中“上行自定义主题映射”，记录映射后的目标主题（上行方向）

4) **下行转发日志（平台下发）**
- 平台发布到规范化下行主题后，若触发“下行自定义主题额外转发”，记录转发到设备原始主题是否成功

不记录：数据库/Redis 连接、缓存命中、系统初始化等与设备交互无关的日志。

## 3. 存储方案（Redis，短期）

插件 `plugin/thingspanel` 已有 Redis 读写封装（`SetRedisForJsondata / GetRedisForJsondata`），调试日志按设备写入 Redis，短期保存即可。

### 3.1 Key 约定

- 调试开关：`tp:devdebug:cfg:{device_id}`
- 调试日志：`tp:devdebug:logs:{device_id}`

### 3.2 调试开关（cfg）

JSON 示例：

```json
{
  "enabled": true,
  "expire_at": 1760000000,
  "max_items": 1000,
  "payload_max_bytes": 4096
}
```

说明：
- 超过 `expire_at` 视为关闭。
- `payload_max_bytes` 用于截断 payload，避免大报文撑爆 Redis 与页面渲染。

### 3.3 调试日志（logs）

Redis List：
- 写入：`LPUSH tp:devdebug:logs:{device_id} <json>`
- 限长：`LTRIM ... 0 (max_items-1)`
- 过期：`EXPIRE ... ttlSeconds`

单条日志 JSON 示例：

```json
{
  "ts": "2026-01-16T14:23:01.123+08:00",
  "event": "auth|subscribe|publish|forward",
  "direction": "up|down|na",
  "device_id": "xxx",
  "client_id": "device001",
  "username": "xxx",
  "topic": "devices/telemetry",
  "payload": "{\"temp\":25}",
  "result": "ok|denied|error|discarded",
  "error": "",
  "extra": {
    "mapped": true,
    "target_topic": "devices/telemetry",
    "source_topic": "xxx/down"
  }
}
```

敏感信息：
- 不记录 password（当前鉴权 voucher 可能包含 password，只写 username/结果/原因）。

## 4. 采集点（基于现有 Hook）

采集入口都在 `plugin/thingspanel/hooks.go`：

- `OnBasicAuthWrapper`：鉴权成功/失败（auth）
- `OnSubscribeWrapper`：订阅允许/拒绝（subscribe）
- `OnMsgArrivedWrapper`：
  - 设备上行：发布主题、是否命中上行自定义映射（publish + up）
  - 平台下行：若触发下行自定义主题额外转发，记录转发结果（forward + down）

写入前统一判断该 `device_id` 是否处于调试开启状态（读取 `tp:devdebug:cfg:{device_id}`）。

## 5. 对外接口（由 IoT 平台提供）

本插件不实现对外 REST 接口；以下 3 个接口由 IoT 平台（ThingsPanel 后端）提供，平台负责读写 Redis 并返回给前端：

1) 开启/关闭调试
- `POST /api/device/{device_id}/debug`（参数：duration 或 expire_at）

2) 查询日志
- `GET /api/device/{device_id}/debug/logs?offset=0&limit=100`

3) 查询调试状态
- `GET /api/device/{device_id}/debug/status`

## 6. 默认参数建议

- 默认开启时长：30 分钟（到期自动关闭）
- `max_items`：1000
- `payload_max_bytes`：4096（可配置为 0：不记录 payload，只记录元信息）
- Redis TTL：`duration + 10 分钟`
