# 主题转换接口设计

## 需求描述

主题转换功能用于实现设备消息主题的动态映射，支持上行和下行两个方向的主题转换。通过配置规则，可以将设备发布/订阅的原始主题转换为平台规范主题，或反之，实现设备协议的灵活适配。

## 数据结构

数据模型定义在 `internal/model/device_topic_mappings.gen.go`：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int64 | 主键ID |
| device_config_id | string | 设备配置ID（必填） |
| name | string | 规则名称（必填） |
| direction | string | 方向：`up`-上行，`down`-下行（必填） |
| source_topic | string | 源主题（必填，支持通配符） |
| target_topic | string | 目标主题（必填，支持通配符） |
| priority | int32 | 优先级，数值越小优先级越高（默认100） |
| enabled | bool | 是否启用（默认true） |
| description | string | 描述信息（可选） |
| created_at | time.Time | 创建时间 |
| updated_at | time.Time | 更新时间 |

## 接口设计

### 1. 获取主题转换列表

#### 接口信息

- **路径**: `/api/v1/device/topic-mappings`
- **方法**: `GET`
- **权限**: 需要登录，根据租户权限过滤数据

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| device_config_id | string | 是 | 设备配置ID | `550e8400-e29b-41d4-a716-446655440000` |
| page | int | 否 | 页码，从1开始（默认1） | `1` |
| page_size | int | 否 | 每页数量，范围1-1000（默认20） | `20` |
| direction | string | 否 | 方向筛选：`up`-上行，`down`-下行 | `up` |
| source_topic | string | 否 | 源主题，模糊匹配 | `device/+/data` |
| target_topic | string | 否 | 目标主题，精确匹配 | `devices/telemetry/+` |
| enabled | bool | 否 | 是否启用筛选 | `true` |
| description | string | 否 | 描述信息，模糊匹配 | `温度传感器` |

#### 响应格式

**成功响应** (200):

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 10,
    "list": [
      {
        "id": 1,
        "device_config_id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "上行遥测主题转换",
        "direction": "up",
        "source_topic": "{device_number}/data/+",
        "target_topic": "devices/telemetry/{device_number}/+",
        "priority": 10,
        "enabled": true,
        "description": "将设备原始主题转换为平台规范主题",
        "created_at": "2025-01-15T10:30:00Z",
        "updated_at": "2025-01-15T10:30:00Z"
      }
    ]
  }
}
```

**响应字段说明**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| total | int64 | 总记录数 |
| list | array | 主题转换规则列表 |
| list[].id | int64 | 规则ID |
| list[].device_config_id | string | 设备配置ID |
| list[].name | string | 规则名称 |
| list[].direction | string | 方向：`up`-上行，`down`-下行 |
| list[].source_topic | string | 源主题 |
| list[].target_topic | string | 目标主题 |
| list[].priority | int32 | 优先级 |
| list[].enabled | bool | 是否启用 |
| list[].description | string | 描述信息 |
| list[].created_at | string | 创建时间（ISO 8601格式） |
| list[].updated_at | string | 更新时间（ISO 8601格式） |

#### 请求示例

```
GET /api/v1/device/topic-mappings?device_config_id=550e8400-e29b-41d4-a716-446655440000&direction=up&page=1&page_size=20
```

---

### 2. 创建主题转换

#### 接口信息

- **路径**: `/api/v1/device/topic-mappings`
- **方法**: `POST`
- **权限**: 需要登录，根据租户权限验证

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| device_config_id | string | 是 | 设备配置ID | `550e8400-e29b-41d4-a716-446655440000` |
| name | string | 是 | 规则名称 | `上行遥测主题转换` |
| direction | string | 是 | 方向：`up`-上行，`down`-下行 | `up` |
| source_topic | string | 是 | 源主题（支持通配符） | `{device_number}/data/+` |
| target_topic | string | 是 | 目标主题（支持通配符） | `devices/telemetry/{device_number}/+` |
| priority | int32 | 否 | 优先级，默认100 | `10` |
| enabled | bool | 否 | 是否启用，默认true | `true` |
| description | string | 否 | 描述信息 | `将设备原始主题转换为平台规范主题` |

#### 请求体示例

```json
{
  "device_config_id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "上行遥测主题转换",
  "direction": "up",
  "source_topic": "{device_number}/data/+",
  "target_topic": "devices/telemetry/{device_number}/+",
  "priority": 10,
  "enabled": true,
  "description": "将设备原始主题转换为平台规范主题"
}
```

#### 响应格式

**成功响应** (200):

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "device_config_id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "上行遥测主题转换",
    "direction": "up",
    "source_topic": "{device_number}/data/+",
    "target_topic": "devices/telemetry/{device_number}/+",
    "priority": 10,
    "enabled": true,
    "description": "将设备原始主题转换为平台规范主题",
    "created_at": "2025-01-15T10:30:00Z",
    "updated_at": "2025-01-15T10:30:00Z"
  }
}
```

---

### 3. 更新主题转换

#### 接口信息

- **路径**: `/api/v1/device/topic-mappings/{id}`
- **方法**: `PUT`
- **权限**: 需要登录，根据租户权限验证

#### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | int64 | 是 | 主题转换规则ID |

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| device_config_id | string | 否 | 设备配置ID | `550e8400-e29b-41d4-a716-446655440000` |
| name | string | 否 | 规则名称 | `上行遥测主题转换` |
| direction | string | 否 | 方向：`up`-上行，`down`-下行 | `up` |
| source_topic | string | 否 | 源主题 | `{device_number}/data/+` |
| target_topic | string | 否 | 目标主题 | `devices/telemetry/{device_number}/+` |
| priority | int32 | 否 | 优先级 | `10` |
| enabled | bool | 否 | 是否启用 | `true` |
| description | string | 否 | 描述信息 | `将设备原始主题转换为平台规范主题` |

**注意**：所有请求参数均为可选，只更新传入的字段。

#### 请求体示例

```json
{
  "priority": 5,
  "enabled": false,
  "description": "已停用的规则"
}
```

#### 响应格式

**成功响应** (200):

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "device_config_id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "上行遥测主题转换",
    "direction": "up",
    "source_topic": "{device_number}/data/+",
    "target_topic": "devices/telemetry/{device_number}/+",
    "priority": 5,
    "enabled": false,
    "description": "已停用的规则",
    "created_at": "2025-01-15T10:30:00Z",
    "updated_at": "2025-01-15T11:00:00Z"
  }
}
```

---

### 4. 删除主题转换

#### 接口信息

- **路径**: `/api/v1/device/topic-mappings/{id}`
- **方法**: `DELETE`
- **权限**: 需要登录，根据租户权限验证

#### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | int64 | 是 | 主题转换规则ID |

#### 响应格式

**成功响应** (200):

```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

---

## 缓存失效策略

### 背景

- 主题转换规则的加载与缓存维护已在子系统中实现（MQTT 钩子 → Redis）。
- 当前文档仅说明**何时触发缓存失效**，确保接口层操作后缓存与数据库保持一致。

### 需要清理的 Key

| Key 模板 | 说明 |
|----------|------|
| `tp:topicmap:up:{device_config_id}` | 上行规则缓存 |
| `tp:topicmap:down:{device_config_id}` | 下行规则缓存 |
| `tp:topicmap:downrev:{device_config_id}` | 下行反向索引（可选，按目标主题回溯原始主题） |

### 触发场景

| 场景 | 说明 | 操作 |
|------|------|------|
| 新增规则 | 成功写入数据库后 | 删除该 `device_config_id` 下所有相关 Key |
| 更新规则 | 成功更新后 | 删除该 `device_config_id` 下所有相关 Key |
| 删除规则 | 成功删除后 | 删除该 `device_config_id` 下所有相关 Key |
| 启用/停用 | `enabled` 发生变化 | 删除该 `device_config_id` 下所有相关 Key |
| 批量操作 | 批量新增/更新/启停/删除 | 聚合出涉及的 `device_config_id` 集合，循环删除 |

### 调用约定

- 服务层在事务提交成功后调用失效逻辑，避免脏数据。
- 若操作影响上下行方向，统一删除 `up`/`down`/`downrev` 三类 Key。
- 删除动作应异步化或快速执行，避免阻塞主流程（可封装为后台任务）。
- 仅依赖**显式删除**保障一致性，TTL 仅作为兜底（推荐 ≥24h）。

### 伪代码示例

```go
func (s *TopicMappingService) invalidate(deviceConfigIDs []string) {
    for _, id := range deviceConfigIDs {
        cache.Delete(fmt.Sprintf("tp:topicmap:up:%s", id))
        cache.Delete(fmt.Sprintf("tp:topicmap:down:%s", id))
        cache.Delete(fmt.Sprintf("tp:topicmap:downrev:%s", id))
    }
}
```

---

## 注意事项

1. **优先级规则**：数值越小优先级越高，匹配时按优先级顺序查找，找到第一个匹配的规则即停止

2. **通配符支持**：
   - 支持 MQTT 通配符：`+`（单级通配符）、`#`（多级通配符）
   - 支持变量替换：`{device_number}`、`{device_id}` 等

3. **方向说明**：
   - **上行（up）**：设备发布消息 → 平台接收，将原始主题转换为规范主题
   - **下行（down）**：平台下发指令 → 设备接收，将规范主题转换为设备原始主题

4. **缓存一致性**：
   - 所有修改操作（增删改、启停）都会清除相关缓存
   - 确保缓存与数据库数据一致

5. **权限控制**：
   - 接口会根据当前登录用户的租户权限自动过滤数据
   - 只能操作本租户下的设备配置的主题转换规则

6. **性能建议**：
   - 单个设备配置的主题转换规则建议不超过 20 条
   - 避免使用过于复杂的通配符模式，影响匹配性能
