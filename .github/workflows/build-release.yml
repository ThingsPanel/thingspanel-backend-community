# ================================================================================================
# ThingsPanel åç«¯ç¤¾åŒºç‰ˆ - è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒå·¥ä½œæµ
# ================================================================================================
# 
# ã€å·¥ä½œæµåŠŸèƒ½è¯´æ˜ã€‘
# æœ¬å·¥ä½œæµç”¨äºè‡ªåŠ¨åŒ–æ„å»ºå’Œå‘å¸ƒ ThingsPanel åç«¯ç¤¾åŒºç‰ˆï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š
# 
# 1. ğŸ”§ å¤šå¹³å°äº¤å‰ç¼–è¯‘ï¼š
#    - Windows (amd64)
#    - Linux (amd64, arm64, arm v7, 386)  
#    - macOS (amd64, arm64)
# 
# 2. ğŸ“¦ è‡ªåŠ¨æ‰“åŒ…ï¼š
#    - Windows å¹³å°æ‰“åŒ…ä¸º .zip æ ¼å¼
#    - å…¶ä»–å¹³å°æ‰“åŒ…ä¸º .tar.gz æ ¼å¼
#    - åŒ…å«å¿…è¦çš„é…ç½®æ–‡ä»¶å’Œèµ„æºæ–‡ä»¶
# 
# 3. ğŸš€ GitHub Release ç®¡ç†ï¼š
#    - è‡ªåŠ¨åˆ›å»º/æ›´æ–° Release
#    - ä¸Šä¼ æ‰€æœ‰å¹³å°çš„æ„å»ºäº§ç‰©
#    - æ”¯æŒæ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬æ ‡ç­¾
# 
# ã€è§¦å‘æ¡ä»¶ã€‘
# - å‘å¸ƒ releaseï¼šè‡ªåŠ¨ä¸ºè¯¥ release æ„å»ºå¹¶ä¸Šä¼ èµ„æºåŒ…
# - æ‰‹åŠ¨è§¦å‘ï¼šå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰æ ‡ç­¾åç§°
# 
# ã€æ„å»ºäº§ç‰©ã€‘
# æ¯ä¸ªå¹³å°ä¼šç”Ÿæˆä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„å‹ç¼©åŒ…ï¼š
# - thingspanel-backend-community å¯æ‰§è¡Œæ–‡ä»¶
# - configs/ é…ç½®æ–‡ä»¶ç›®å½•
# - sql/ æ•°æ®åº“è„šæœ¬ç›®å½•  
# - files/ èµ„æºæ–‡ä»¶ç›®å½•
# ================================================================================================

name: Build and Release

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  release:
    types: [published]  # å½“å‘å¸ƒ release æ—¶è§¦å‘
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      tag:
        description: 'Tag name'    # æ‰‹åŠ¨è§¦å‘æ—¶å¯ä»¥æŒ‡å®šæ ‡ç­¾å
        required: false
        default: 'latest'

jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu æœ€æ–°ç‰ˆæœ¬ä½œä¸ºæ„å»ºç¯å¢ƒ
    steps:
    
    # æ­¥éª¤1: æ£€å‡ºä»£ç ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v3
    
    # æ­¥éª¤2: è®¾ç½® Go å¼€å‘ç¯å¢ƒ
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'  # ä½¿ç”¨ Go 1.23 ç‰ˆæœ¬
    
    # æ­¥éª¤3: ç¡®å®šå‘å¸ƒæ ‡ç­¾
    # å¦‚æœæ˜¯ release è§¦å‘åˆ™ä½¿ç”¨ release æ ‡ç­¾ï¼Œæ‰‹åŠ¨è§¦å‘åˆ™ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æ ‡ç­¾
    - name: Determine Release Tag
      id: determine-tag
      run: echo "RELEASE_TAG=$(if [ '${{ github.event_name }}' == 'release' ]; then echo '${{ github.event.release.tag_name }}'; else echo '${{ github.event.inputs.tag }}'; fi)" >> $GITHUB_ENV
    
    # æ­¥éª¤4: è·å–ç°æœ‰ Release ä¿¡æ¯
    # è·å–å½“å‰ Release çš„ä¿¡æ¯ç”¨äºåç»­ä¸Šä¼ èµ„æº
    - name: Get Release Info
      id: get_release
      run: |
        if [ '${{ github.event_name }}' == 'release' ]; then
          echo "RELEASE_ID=${{ github.event.release.id }}" >> $GITHUB_ENV
          echo "RELEASE_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          echo "Using existing release: ${{ github.event.release.tag_name }}"
        else
          # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œè·å–æˆ–åˆ›å»º Release
          tag=${{ github.event.inputs.tag || 'latest' }}
          echo "RELEASE_TAG=$tag" >> $GITHUB_ENV
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥æ ‡ç­¾çš„ Release
          release_response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$tag")
          
          release_id=$(echo "$release_response" | jq -r '.id')
          
          if [ "$release_id" != "null" ] && [ "$release_id" != "" ]; then
            echo "RELEASE_ID=$release_id" >> $GITHUB_ENV
            echo "Using existing release with ID: $release_id"
          else
            # åˆ›å»ºæ–°çš„ Release
            create_response=$(curl -s -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases" \
              -d "{
                \"tag_name\": \"$tag\",
                \"name\": \"Release $tag\",
                \"body\": \"Release created by GitHub Actions. Tag $tag\",
                \"draft\": false,
                \"prerelease\": false
              }")
            
            new_release_id=$(echo "$create_response" | jq -r '.id')
            echo "RELEASE_ID=$new_release_id" >> $GITHUB_ENV
            echo "Created new release with ID: $new_release_id"
          fi
        fi
    
    # æ­¥éª¤5: å¤šå¹³å°äº¤å‰ç¼–è¯‘å’Œæ‰“åŒ…
    # è¿™æ˜¯æ•´ä¸ªå·¥ä½œæµçš„æ ¸å¿ƒæ­¥éª¤ï¼Œä¸ºå¤šä¸ªç›®æ ‡å¹³å°æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
    - name: Build and package for multiple platforms
      run: |
        # å®šä¹‰è¦æ„å»ºçš„ç›®æ ‡å¹³å°åˆ—è¡¨
        # æ ¼å¼: "æ“ä½œç³»ç»Ÿ/æ¶æ„/ARMç‰ˆæœ¬" (ARMç‰ˆæœ¬æ˜¯å¯é€‰çš„)
        platforms=(
          "windows/amd64"   # Windows 64ä½
          "linux/amd64"     # Linux 64ä½
          "linux/arm64"     # Linux ARM64 (Apple Mç³»åˆ—èŠ¯ç‰‡ç­‰)
          "linux/arm/7"     # Linux ARMv7 (æ ‘è“æ´¾ç­‰åµŒå…¥å¼è®¾å¤‡)
          "linux/386"       # Linux 32ä½
          "darwin/amd64"    # macOS Intel èŠ¯ç‰‡
          "darwin/arm64"    # macOS Apple èŠ¯ç‰‡ (M1/M2ç­‰)
        )
        
        # éå†æ¯ä¸ªç›®æ ‡å¹³å°è¿›è¡Œæ„å»º
        for platform in "${platforms[@]}"; do
          # è§£æå¹³å°å­—ç¬¦ä¸²ï¼Œåˆ†åˆ«æå–æ“ä½œç³»ç»Ÿã€æ¶æ„å’ŒARMç‰ˆæœ¬
          IFS="/" read -r os arch arm_version <<< "$platform"
          
          # è®¾ç½® Go äº¤å‰ç¼–è¯‘çš„ç¯å¢ƒå˜é‡
          export GOOS=$os        # ç›®æ ‡æ“ä½œç³»ç»Ÿ
          export GOARCH=$arch    # ç›®æ ‡æ¶æ„
          export CGO_ENABLED=0   # ç¦ç”¨ CGOï¼Œç¡®ä¿é™æ€é“¾æ¥
          
          # å¦‚æœæ˜¯ ARM å¹³å°ï¼Œè®¾ç½® GOARM ç‰ˆæœ¬
          if [ ! -z "$arm_version" ]; then
            export GOARM=$arm_version
            platform_suffix="$os-$arch-v$arm_version"  # å¹³å°åç¼€åŒ…å«ARMç‰ˆæœ¬
          else
            unset GOARM
            platform_suffix="$os-$arch"                # æ™®é€šå¹³å°åç¼€
          fi
          
          echo "Building for $GOOS/$GOARCH${GOARM:+/v$GOARM}..."
          
          # ä¸ºå½“å‰å¹³å°åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p "dist/$platform_suffix"
          
          # å¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶å’Œèµ„æºæ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
          cp -r configs "dist/$platform_suffix/" 2>/dev/null || echo "No configs directory found"
          cp -r sql "dist/$platform_suffix/" 2>/dev/null || echo "No sql directory found"
          cp -r files "dist/$platform_suffix/" 2>/dev/null || echo "No files directory found"
          
          # æ ¹æ®ç›®æ ‡æ“ä½œç³»ç»Ÿç¡®å®šå¯æ‰§è¡Œæ–‡ä»¶åï¼ˆWindowséœ€è¦.exeåç¼€ï¼‰
          if [ "$os" == "windows" ]; then
             output_file="dist/$platform_suffix/thingspanel-backend-community.exe"
          else
             output_file="dist/$platform_suffix/thingspanel-backend-community"
          fi
          
          # æ‰§è¡Œ Go æ„å»ºå‘½ä»¤
          go build -o "$output_file"
          
          # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
          if [ $? -ne 0 ]; then
            echo "Failed to build for $GOOS/$GOARCH${GOARM:+/v$GOARM}, skipping..."
            rm -rf "dist/$platform_suffix"  # æ„å»ºå¤±è´¥åˆ™åˆ é™¤ç›®å½•
            continue
          fi
          
          # æ ¹æ®å¹³å°ç±»å‹åˆ›å»ºä¸åŒæ ¼å¼çš„å‹ç¼©åŒ…
          if [ "$os" == "windows" ]; then
            archive_name="thingspanel-backend-community-$platform_suffix.zip"
            # Windows å¹³å°æ‰“åŒ…ä¸º ZIP æ ¼å¼
            (cd dist && zip -r "../$archive_name" "$platform_suffix")
          else
            archive_name="thingspanel-backend-community-$platform_suffix.tar.gz"
            # å…¶ä»–å¹³å°æ‰“åŒ…ä¸º tar.gz æ ¼å¼
            tar -czf "$archive_name" -C dist "$platform_suffix"
          fi
          
          echo "Created archive: $archive_name"
        done
        
        # åˆ—å‡ºæ‰€æœ‰åˆ›å»ºçš„å‹ç¼©åŒ…æ–‡ä»¶
        ls -la *.tar.gz *.zip 2>/dev/null || echo "No archives created"
    
    # æ­¥éª¤6: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° GitHub Release
    # å°†æ‰€æœ‰å¹³å°çš„å‹ç¼©åŒ…ä¸Šä¼ ä¸º Release çš„é™„ä»¶
    - name: Upload Release Assets
      id: upload-release-assets
      run: |
        # éå†æ‰€æœ‰ç”Ÿæˆçš„å‹ç¼©åŒ…æ–‡ä»¶
        for asset in ./thingspanel-backend-community-*.tar.gz ./thingspanel-backend-community-*.zip; do
          if [ -f "$asset" ]; then
            asset_name=$(basename "$asset")
            echo "Uploading $asset_name..."
            
            # æ£€æŸ¥èµ„æºæ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™å…ˆåˆ é™¤
            echo "Checking for existing asset: $asset_name"
            assets_response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets")
            
            echo "Assets response: $assets_response"
            
            existing_asset_id=$(echo "$assets_response" | jq -r ".[] | select(.name == \"$asset_name\") | .id")
            
            if [ "$existing_asset_id" != "null" ] && [ ! -z "$existing_asset_id" ] && [ "$existing_asset_id" != "" ]; then
              echo "Found existing asset: $asset_name (ID: $existing_asset_id)"
              echo "Deleting existing asset..."
              
              delete_response=$(curl -s -w "%{http_code}" -X DELETE \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/assets/$existing_asset_id")
              
              http_code="${delete_response: -3}"
              if [ "$http_code" == "204" ]; then
                echo "Successfully deleted existing asset"
                sleep 3  # å¢åŠ ç­‰å¾…æ—¶é—´
              else
                echo "Failed to delete existing asset (HTTP $http_code)"
                echo "Delete response: ${delete_response%???}"
                # ç»§ç»­å°è¯•ä¸Šä¼ ï¼Œè®© GitHub API è¿”å›æ›´è¯¦ç»†çš„é”™è¯¯
              fi
            else
              echo "No existing asset found with name: $asset_name"
            fi
            
            # æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®æ­£ç¡®çš„ Content-Type
            content_type="application/gzip"
            if [[ "$asset" == *.zip ]]; then
              content_type="application/zip"
            fi
            
            # é€šè¿‡ GitHub API ä¸Šä¼ æ–‡ä»¶åˆ° Release
            echo "Uploading $asset_name to release ID: $RELEASE_ID"
            upload_response=$(curl -s -w "%{http_code}" -XPOST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: $content_type" \
              --data-binary "@$asset" \
              "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$asset_name")
            
            http_code="${upload_response: -3}"
            if [ "$http_code" == "201" ]; then
              echo "âœ… Successfully uploaded $asset_name"
            else
              echo "âŒ Failed to upload $asset_name (HTTP $http_code)"
              echo "Response: ${upload_response%???}"
              exit 1
            fi
          fi
        done
    
    # æ­¥éª¤7: è§¦å‘ Docker é•œåƒæ„å»ºå·¥ä½œæµ
    # åœ¨å®Œæˆ Release åˆ›å»ºåï¼Œè‡ªåŠ¨è§¦å‘ Docker é•œåƒæ„å»º
    # - name: Trigger Docker Image Build
    #   run: |
    #     tag=$RELEASE_TAG
    #     echo "Triggering docker-image-build.yml workflow for tag: $tag"
        
    #     # é€šè¿‡ GitHub API è§¦å‘ docker-image-build.yml å·¥ä½œæµ
    #     curl -X POST \
    #       -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
    #       -H "Accept: application/vnd.github.v3+json" \
    #       "https://api.github.com/repos/${{ github.repository }}/actions/workflows/docker-image-build.yml/dispatches" \
    #       -d '{"ref":"main"}'
        
    #     echo "Docker image build workflow triggered successfully"

    - name: Trigger installer build
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.repos.createDispatchEvent({
            owner: 'ThingsPanel',
            repo: 'thingspanel-installation',
            event_type: 'backend-release',
            client_payload: {
              version: '${{ env.RELEASE_TAG }}'
            }
          });